# Architecture Comparison

## ğŸ”´ OLD ARCHITECTURE (Content Script Based)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POPUP.TSX                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ sendMessageToCurrentTab(data)                       â”‚        â”‚
â”‚ â”‚ â€¢ chrome.tabs.update(url)                           â”‚        â”‚
â”‚ â”‚ â€¢ âŒ KhÃ´ng biáº¿t káº¿t quáº£                              â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ URL update
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TARGET PAGE (hanhchinhcong.vnpost.vn)                           â”‚
â”‚                                                                  â”‚
â”‚  window.onload â†’ contentScript.tsx tá»± Ä‘á»™ng cháº¡y                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ Auto execute
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONTENTSCRIPT.TSX (~230 lines)                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ handleExistingInput()                                â”‚        â”‚
â”‚ â”‚ â€¢ waitForElm(checkbox)                               â”‚        â”‚
â”‚ â”‚ â€¢ checkbox.checked = true                            â”‚        â”‚
â”‚ â”‚ â€¢ submitButton.click()                               â”‚        â”‚
â”‚ â”‚ â€¢ chrome.runtime.sendMessage({message: "finded"})    â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ Page refresh sau click submit
                       â–¼
                   âŒ Máº¤T STATE
                   âŒ KHÃ“ QUáº¢N LÃ LUá»’NG
                   âŒ MESSAGE PASSING PHá»¨C Táº P
```

---

## ğŸŸ¢ NEW ARCHITECTURE (Scripting API Based)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POPUP.TSX                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ async sendMessageToCurrentTab(data)                 â”‚        â”‚
â”‚ â”‚                                                      â”‚        â”‚
â”‚ â”‚ 1ï¸âƒ£  chrome.tabs.update(url)                         â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ URL update
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TARGET PAGE                                                      â”‚
â”‚  Loading... (khÃ´ng cÃ³ automation tá»± Ä‘á»™ng)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ Wait for complete
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POPUP.TSX (continued)                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ 2ï¸âƒ£  await chrome.tabs.onUpdated                     â”‚        â”‚
â”‚ â”‚    (Ä‘á»£i status === 'complete')                       â”‚        â”‚
â”‚ â”‚                                                      â”‚        â”‚
â”‚ â”‚ 3ï¸âƒ£  chrome.scripting.executeScript({                â”‚        â”‚
â”‚ â”‚      target: { tabId },                              â”‚        â”‚
â”‚ â”‚      func: () => {                                   â”‚        â”‚
â”‚ â”‚        // Code cháº¡y trong page context               â”‚        â”‚
â”‚ â”‚        return Promise.race([                         â”‚        â”‚
â”‚ â”‚          waitForElement(checkbox),                   â”‚        â”‚
â”‚ â”‚          waitForNoResultText()                       â”‚        â”‚
â”‚ â”‚        ])                                            â”‚        â”‚
â”‚ â”‚      }                                               â”‚        â”‚
â”‚ â”‚    })                                                â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ Return result
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POPUP.TSX (handle result)                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ 4ï¸âƒ£  const result = { success, reason, name }        â”‚        â”‚
â”‚ â”‚                                                      â”‚        â”‚
â”‚ â”‚    if (success) {                                    â”‚        â”‚
â”‚ â”‚      Firebase.set("continueCCCD")                    â”‚        â”‚
â”‚ â”‚      notification("âœ“ ThÃ nh cÃ´ng")                    â”‚        â”‚
â”‚ â”‚    }                                                 â”‚        â”‚
â”‚ â”‚    else if (not_found) {                             â”‚        â”‚
â”‚ â”‚      Firebase.set("notFound", name)                  â”‚        â”‚
â”‚ â”‚      notification("âœ— KhÃ´ng tÃ¬m tháº¥y")                â”‚        â”‚
â”‚ â”‚    }                                                 â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
                   âœ… FULL CONTROL
                   âœ… TRACKABLE STATE
                   âœ… PROMISE-BASED
                   âœ… Dá»„ DEBUG
```

---

## ğŸ” Chi tiáº¿t Automation Script

### Script Ä‘Æ°á»£c inject vÃ o page:

```javascript
chrome.scripting.executeScript({
  target: { tabId },
  func: (): Promise<AutomationResult> => {
    return new Promise((resolve) => {
      
      // Helper 1: Äá»£i element
      function waitForElement(selector, timeout = 5000) {
        // MutationObserver logic...
      }
      
      // Helper 2: Äá»£i text "KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£"
      function waitForNoResultText(timeout = 5000) {
        // MutationObserver logic...
      }
      
      // Main automation
      (async () => {
        try {
          // Race condition: cÃ¡i nÃ o Ä‘áº¿n trÆ°á»›c
          const result = await Promise.race([
            waitForElement("#listTbody tr td div input"),
            waitForNoResultText()
          ]);
          
          if (result.type === 'noResult') {
            resolve({ 
              success: false, 
              reason: 'not_found',
              name: document.querySelector("#HoTen").value
            });
          }
          
          if (result.type === 'checkbox') {
            // Check checkbox
            checkbox.checked = true;
            checkbox.dispatchEvent(new Event('change'));
            
            // Wait for UI
            await new Promise(r => setTimeout(r, 300));
            
            // Click submit
            const submitBtn = document.getElementById("sub_xacnhan");
            if (submitBtn && !submitBtn.disabled) {
              submitBtn.click();
              resolve({ success: true, reason: 'submitted' });
            } else {
              resolve({ 
                success: false, 
                reason: 'submit_disabled' 
              });
            }
          }
        } catch (error) {
          resolve({ 
            success: false, 
            reason: 'error',
            error: String(error)
          });
        }
      })();
    });
  }
});
```

---

## ğŸ“Š Comparison Table

| Aspect | Old (Content Script) | New (Scripting API) |
|--------|---------------------|---------------------|
| **Code Location** | contentScript.tsx | popup.tsx |
| **Lines of Code** | ~230 lines | ~150 lines inline |
| **Control Flow** | Event-driven | Promise-based |
| **State Management** | Lost on refresh | Preserved in popup |
| **Result Tracking** | Message passing | Direct return value |
| **Debugging** | Multiple consoles | Single popup console |
| **Error Handling** | try/catch + messages | try/catch + return |
| **Maintainability** | â­â­ | â­â­â­â­â­ |

---

## ğŸ¯ Key Benefits

1. **Táº­p trung hÃ³a**: Táº¥t cáº£ logic á»Ÿ má»™t nÆ¡i (popup.tsx)
2. **Minh báº¡ch**: Biáº¿t chÃ­nh xÃ¡c káº¿t quáº£ automation
3. **Linh hoáº¡t**: Dá»… thÃªm logic xá»­ lÃ½ phá»©c táº¡p
4. **Reliable**: KhÃ´ng bá»‹ áº£nh hÆ°á»Ÿng bá»Ÿi page lifecycle
5. **Modern**: Sá»­ dá»¥ng async/await thay vÃ¬ callbacks

---

## ğŸš€ Next Steps

1. Test vá»›i real data tá»« Firebase
2. Monitor performance vÃ  error rate
3. Consider adding retry logic
4. Add metrics tracking
5. Improve error handling cho edge cases
