{"version":3,"file":"background.js","mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack:///./src/background/background.ts"],"sourcesContent":["\"use strict\";\n// background.ts (MV3 service worker)\n// ==================== MODAL DETECTION SYSTEM ====================\n// Listener ƒë·ªÉ ph√°t hi·ªán modal sau khi trang reload\nchrome.tabs.onUpdated.addListener((updatedTabId, info, _tab) => {\n    if (info.status === \"complete\") {\n        chrome.storage.session.get(['waitingForModalTab']).then(({ waitingForModalTab }) => {\n            if (waitingForModalTab === updatedTabId) {\n                console.log(\"‚úÖ Background: Tab reloaded completely, injecting modal detector...\");\n                // Inject script ƒë·ªÉ ki·ªÉm tra modal\n                chrome.scripting.executeScript({\n                    target: { tabId: updatedTabId },\n                    func: () => {\n                        // Helper function: ƒë·ª£i element xu·∫•t hi·ªán\n                        function waitForElm(selector, timeout = 10000) {\n                            return new Promise((resolve) => {\n                                const element = document.querySelector(selector);\n                                if (element) {\n                                    console.log(`‚úÖ Modal \"${selector}\" ƒë√£ t·ªìn t·∫°i ngay l·∫≠p t·ª©c!`);\n                                    return resolve(element);\n                                }\n                                const observer = new MutationObserver(() => {\n                                    const element = document.querySelector(selector);\n                                    if (element) {\n                                        console.log(`‚úÖ Modal \"${selector}\" xu·∫•t hi·ªán sau khi ch·ªù!`);\n                                        observer.disconnect();\n                                        resolve(element);\n                                    }\n                                });\n                                observer.observe(document.body, {\n                                    childList: true,\n                                    subtree: true,\n                                });\n                                setTimeout(() => {\n                                    observer.disconnect();\n                                    console.log(`‚ö†Ô∏è Timeout waiting for modal \"${selector}\"`);\n                                    resolve(null);\n                                }, timeout);\n                            });\n                        }\n                        // B·∫Øt ƒë·∫ßu ch·ªù modal\n                        console.log(\"üîç Starting modal detection...\");\n                        waitForElm(\"#flash-overlay-modal\").then((elm) => {\n                            if (elm) {\n                                console.log(\"‚úÖ MODAL DETECTED! Sending message to background...\");\n                                // ‚úÖ Send message v·ªÅ background (script context c√≥ th·ªÉ g·ªçi chrome.runtime)\n                                chrome.runtime.sendMessage({\n                                    action: \"modalDetected\",\n                                    success: true,\n                                    timestamp: Date.now()\n                                });\n                            }\n                            else {\n                                console.log(\"‚ùå Modal not found within timeout\");\n                                chrome.runtime.sendMessage({\n                                    action: \"modalDetected\",\n                                    success: false,\n                                    reason: \"timeout\",\n                                    timestamp: Date.now()\n                                });\n                            }\n                        });\n                    }\n                }).then(() => {\n                    console.log(\"‚úì Background: Modal detector script injected successfully\");\n                    // ‚ùå KH√îNG X√ìA FLAG ·ªû ƒê√ÇY - ƒë·ªÉ script trong tab t·ª± x√≥a sau khi detect xong\n                }).catch(err => {\n                    console.error(\"‚ùå Background: Failed to inject modal detector:\", err);\n                    // Cleanup flag tr√™n l·ªói\n                    chrome.storage.session.remove(['waitingForModalTab']);\n                });\n            }\n        });\n    }\n});\n// ‚úÖ Listener nh·∫≠n message t·ª´ modal detector script v√† l∆∞u v√†o storage\nchrome.runtime.onMessage.addListener((message, _sender, _sendResponse) => {\n    if (message.action === \"modalDetected\") {\n        console.log(\"üì® Background received modal detection result:\", message);\n        // L∆∞u k·∫øt qu·∫£ v√†o storage\n        chrome.storage.session.set({\n            modalDetectionResult: {\n                success: message.success,\n                reason: message.reason,\n                timestamp: message.timestamp || Date.now()\n            }\n        }).then(() => {\n            console.log(\"‚úÖ Background saved modal result to storage:\", message.success);\n            // Cleanup flag\n            chrome.storage.session.remove(['waitingForModalTab']);\n        });\n    }\n});\n// ==================== EXTENSION ICON CLICK HANDLER ====================\n// Khi click v√†o icon extension, m·ªü trang options\nif (chrome.action && chrome.action.onClicked) {\n    chrome.action.onClicked.addListener(() => {\n        console.log(\"üñ±Ô∏è Extension icon clicked, opening options page...\");\n        chrome.runtime.openOptionsPage();\n    });\n}\nelse {\n    console.warn(\"‚ö†Ô∏è chrome.action is not available. Make sure 'action' is defined in manifest.json\");\n}\nconsole.log(\"‚úÖ CCCD Background Service Worker loaded - Modal detection ready\");\n"],"names":[],"sourceRoot":""}